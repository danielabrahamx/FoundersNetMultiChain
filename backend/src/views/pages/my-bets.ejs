<%- include('../layouts/main', { body: ` <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-2">My Bets</h1>
        <p class="text-gray-400">Track your positions across all markets</p>
    </div>

    <!-- Wallet Check -->
    <div id="my-bets-content">
        <!-- Initial loading state - replaced by HTMX -->
        <div class="text-center py-12">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/20 mb-4">
                <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-2">Connect Your Wallet</h3>
            <p class="text-gray-400 text-sm mb-4">
                Connect your wallet to view your betting history and positions.
            </p>
            <button onclick="connectWallet()"
                class="px-6 py-2.5 btn-primary text-white rounded-lg font-medium transition-all focus:ring-2 focus:ring-primary/50 focus:outline-none">
                Connect Wallet
            </button>
        </div>
    </div>

    <!-- HTMX: Load user bets when wallet is connected -->
    <div id="user-bets-container" class="hidden">
        <div class="text-center py-12">
            <svg class="w-8 h-8 animate-spin text-primary mx-auto" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <p class="text-gray-400 mt-4">Loading your bets...</p>
        </div>
    </div>

    <script>
        // Track if we've already loaded bets
        let betsLoaded = false;

        // Load user bets via direct fetch then HTMX swap
        async function loadUserBets() {
            // Get wallet address from multiple sources
            const walletAddr = window.walletAddress || (window.wallet && window.wallet.address);

            console.log('[My Bets] loadUserBets called, address:', walletAddr);

            if (!walletAddr) {
                console.log('[My Bets] No wallet connected, showing connect prompt');
                document.getElementById('my-bets-content').classList.remove('hidden');
                document.getElementById('user-bets-container').classList.add('hidden');
                betsLoaded = false;
                return;
            }

            // Prevent re-loading if already loaded for same address
            if (betsLoaded) {
                console.log('[My Bets] Already loaded bets');
                return;
            }

            console.log('[My Bets] Loading bets for:', walletAddr);
            document.getElementById('my-bets-content').classList.add('hidden');
            document.getElementById('user-bets-container').classList.remove('hidden');

            try {
                // Directly fetch the HTMX partial with the address
                const response = await fetch('/my-bets/list?address=' + encodeURIComponent(walletAddr));
                const html = await response.text();

                // Insert the HTML
                document.getElementById('user-bets-container').innerHTML = html;
                betsLoaded = true;
                console.log('[My Bets] Successfully loaded bets');
            } catch (error) {
                console.error('[My Bets] Error loading bets:', error);
                document.getElementById('user-bets-container').innerHTML =
                    '<div class="text-center py-12 text-red-400">Failed to load bets. <button onclick="betsLoaded=false;loadUserBets()" class="underline">Try again</button></div>';
            }
        }

        // Listen for wallet connection events
        document.addEventListener('wallet:connected', function (e) {
            console.log('[My Bets] wallet:connected event received', e.detail);
            betsLoaded = false; // Reset so we reload
            loadUserBets();
        });

        document.addEventListener('wallet:disconnected', function () {
            console.log('[My Bets] wallet:disconnected event received');
            betsLoaded = false;
            loadUserBets();
        });

        // Wait for wallet.js to initialize, then check if connected
        function waitForWalletInit() {
            // Check if wallet.js is loaded and has restored session
            if (typeof window.wallet !== 'undefined' && window.wallet) {
                console.log('[My Bets] Wallet module loaded, checking address');
                if (window.walletAddress || (window.wallet.address)) {
                    console.log('[My Bets] Wallet already connected');
                    loadUserBets();
                } else {
                    console.log('[My Bets] Wallet not connected yet, will wait for event');
                }
            } else {
                console.log('[My Bets] Waiting for wallet.js to load...');
                setTimeout(waitForWalletInit, 100);
            }
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(waitForWalletInit, 100);
            });
        } else {
            setTimeout(waitForWalletInit, 100);
        }
    </script>
    ` }) %>