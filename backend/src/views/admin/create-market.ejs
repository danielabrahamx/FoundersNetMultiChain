<%# Create Market Form - Admin only %>
    <%- include('../layouts/main', { body: ` <!-- Admin Mode Indicator -->
        <div class="mb-6 flex items-center gap-3 p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/30">
            <div class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
            <div class="flex-1">
                <span class="font-semibold text-yellow-400">Admin Mode Active</span>
                <span class="text-yellow-200/70 text-sm ml-2">Creating New Market</span>
            </div>
            <a id="back-to-dashboard" href="/admin" class="text-yellow-400 hover:text-yellow-300 text-sm">← Back to
                Dashboard</a>
        </div>

        <div class="max-w-2xl mx-auto">
            <!-- Page Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold mb-2">Create New Market</h1>
                <p class="text-gray-400">Define a new prediction market for users to bet on.</p>
            </div>

            <!-- Create Market Form -->
            <form id="create-market-form" class="card-glass rounded-2xl p-6 md:p-8">
                <!-- Question Input -->
                <div class="mb-6">
                    <label for="market-question" class="block text-sm font-medium text-gray-300 mb-2">
                        Market Question
                    </label>
                    <textarea id="market-question" name="question" rows="3" maxlength="500"
                        placeholder="e.g., Will Acme Corp raise Series A by December 2024?" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-white placeholder-gray-500
                       focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50
                       resize-none transition-all" required></textarea>
                    <div class="flex justify-between mt-2 text-xs text-gray-500">
                        <span>Be specific and unambiguous about the outcome.</span>
                        <span id="char-count">0/500</span>
                    </div>
                </div>

                <!-- Close Time Input -->
                <div class="mb-6">
                    <label for="close-time" class="block text-sm font-medium text-gray-300 mb-2">
                        Betting Close Time
                    </label>
                    <input type="datetime-local" id="close-time" name="closeTime" class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-white
                       focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50
                       transition-all" required />
                    <p class="mt-2 text-xs text-gray-500">
                        After this time, no new bets will be accepted. Choose a time before the expected outcome is
                        known.
                    </p>
                </div>

                <!-- Preview Section -->
                <div id="market-preview" class="mb-8 hidden">
                    <h3 class="text-sm font-medium text-gray-400 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Market Preview
                    </h3>
                    <div class="card-glass rounded-xl p-5 border border-primary/30">
                        <h4 id="preview-question" class="text-lg font-medium text-white mb-3"></h4>
                        <div class="flex flex-wrap gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yes"></span>
                                <span class="text-gray-400">YES: 50%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-no"></span>
                                <span class="text-gray-400">NO: 50%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="preview-close-time" class="text-gray-400"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn" class="w-full px-6 py-4 btn-primary text-white rounded-xl transition-all font-medium text-lg
                   focus:ring-2 focus:ring-primary/50 focus:outline-none
                   hover:shadow-lg hover:shadow-primary/25 active:scale-[0.98]
                   disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-none" disabled>
                    <span id="submit-text" class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Create Market
                    </span>
                    <span id="submit-loading" class="hidden flex items-center justify-center gap-2">
                        <svg class="w-5 h-5 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Creating...
                    </span>
                </button>

                <!-- Transaction Status -->
                <div id="tx-status" class="mt-6 hidden">
                    <div id="tx-pending" class="hidden p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-yellow-400 spinner" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span class="text-yellow-400">Transaction pending...</span>
                        </div>
                        <a id="tx-link" href="#" target="_blank" rel="noopener noreferrer"
                            class="inline-block mt-2 text-sm text-yellow-400/70 hover:text-yellow-400">
                            View on Explorer →
                        </a>
                    </div>
                    <div id="tx-success" class="hidden p-4 rounded-lg bg-yes/10 border border-yes/30">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-yes" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            <span class="text-yes">Market created successfully!</span>
                        </div>
                        <a href="/admin" class="inline-block mt-2 text-sm text-yes/70 hover:text-yes">
                            Return to Dashboard →
                        </a>
                    </div>
                    <div id="tx-error" class="hidden p-4 rounded-lg bg-no/10 border border-no/30">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-no" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <span id="error-message" class="text-no">Transaction failed.</span>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Tips Section -->
            <div class="mt-8 card-glass rounded-xl p-6">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Tips for Good Market Questions</h3>
                <ul class="space-y-2 text-sm text-gray-300">
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-yes mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Be specific about the company, event, and deadline.
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-yes mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Ensure the outcome can be objectively verified (e.g., press releases, SEC filings).
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-yes mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Set the close time before the expected announcement.
                    </li>
                    <li class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-no mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        Avoid ambiguous terms that could lead to disputes.
                    </li>
                </ul>
            </div>
        </div>

        <script>
            const questionInput = document.getElementById('market-question');
            const closeTimeInput = document.getElementById('close-time');
            const charCount = document.getElementById('char-count');
            const previewSection = document.getElementById('market-preview');
            const previewQuestion = document.getElementById('preview-question');
            const previewCloseTime = document.getElementById('preview-close-time');
            const submitBtn = document.getElementById('submit-btn');
            const form = document.getElementById('create-market-form');

            // Set minimum datetime to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            closeTimeInput.min = now.toISOString().slice(0, 16);

            // Character count
            questionInput.addEventListener('input', updatePreview);
            closeTimeInput.addEventListener('input', updatePreview);

            function updatePreview() {
                const question = questionInput.value.trim();
                const closeTime = closeTimeInput.value;

                // Update char count
                charCount.textContent = question.length + '/500';

                // Show preview if both fields have values
                if (question && closeTime) {
                    previewSection.classList.remove('hidden');
                    previewQuestion.textContent = question;
                    previewCloseTime.textContent = 'Closes: ' + new Date(closeTime).toLocaleString();
                    submitBtn.disabled = false;
                } else {
                    previewSection.classList.add('hidden');
                    submitBtn.disabled = true;
                }
            }

            // Form submission
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const question = questionInput.value.trim();
                const closeTimeValue = closeTimeInput.value;

                if (!question || !closeTimeValue) return;

                const closeTimeUnix = Math.floor(new Date(closeTimeValue).getTime() / 1000);

                // Show loading
                document.getElementById('submit-text').classList.add('hidden');
                document.getElementById('submit-loading').classList.remove('hidden');
                submitBtn.disabled = true;

                try {
                    // Check if wallet is connected
                    if (!window.wallet || !window.wallet.isConnected()) {
                        throw new Error('Please connect your wallet first');
                    }

                    // Check if on correct network
                    if (!window.wallet.isCorrectNetwork()) {
                        throw new Error('Please switch to the correct network');
                    }

                    // Get transaction data from server
                    const response = await fetch('/api/admin/tx/create-market', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-wallet-address': window.wallet.address,
                        },
                        body: JSON.stringify({
                            question,
                            closeTime: closeTimeUnix,
                        }),
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.error || 'Failed to build transaction');
                    }

                    // Send transaction using wallet manager
                    const txHash = await window.wallet.signTransaction(data.transaction);

                    if (!txHash) {
                        throw new Error('Transaction was cancelled');
                    }

                    // Show pending status
                    document.getElementById('tx-status').classList.remove('hidden');
                    document.getElementById('tx-pending').classList.remove('hidden');
                    document.getElementById('tx-link').href = window.appConfig.blockExplorer + '/tx/' + txHash;

                    // Wait for confirmation using wallet manager
                    const receipt = await window.wallet.waitForReceipt(txHash);

                    if (receipt.status !== '0x1' && receipt.status !== 1) {
                        throw new Error('Transaction failed on-chain');
                    }

                    // Show success
                    document.getElementById('tx-pending').classList.add('hidden');
                    document.getElementById('tx-success').classList.remove('hidden');

                } catch (error) {
                    console.error('Create market error:', error);
                    document.getElementById('tx-status').classList.remove('hidden');
                    document.getElementById('tx-error').classList.remove('hidden');
                    document.getElementById('error-message').textContent = error.message || 'Transaction failed';
                } finally {
                    document.getElementById('submit-text').classList.remove('hidden');
                    document.getElementById('submit-loading').classList.add('hidden');
                    submitBtn.disabled = false;
                }
            });

            // Update back-to-dashboard link with wallet param
            document.addEventListener('DOMContentLoaded', function () {
                const backLink = document.getElementById('back-to-dashboard');
                if (backLink && window.appConfig && window.appConfig.adminAddress) {
                    backLink.href = '/admin?wallet=' + encodeURIComponent(window.appConfig.adminAddress);
                }
            });
        </script>
        ` }) %>